# [임베디드SW] 23. 우선순위 계승 프로토콜

<aside>

# 💖 실시간 스케줄링의 문제점과 해결책

</aside>

항상 이상적이지는 않다. 실제로 어떤 일들이 일어날 수 있는지, 그걸 어떻게 해결하는지 알아보자.

<aside>

# 💖 우선 순위 전도 현상

</aside>

## 우선 순위 전도 현상이란?

<aside>

**우선 순위 전도 현상(Indefinite priority inversion)**

높은 우선 순위의 태스크가 낮은 우선 순위의 태스크에 의해서 블럭킹되는 현상

</aside>

## 언제 이런 상황이 발생하나요?

공유자원을 사용할 때 발생합니다.

1. 우선순위가 고정되어있고
2. 선점형 스케쥴링일 때 발생합니다.
- ex) 위에서 배운 RMS 방식

### 발생 상황 예시

![priority: J1>J2>J3](image%2051.png)

priority: J1>J2>J3

- 우선순위가 더 낮은 J2는 실행되는데 더 우선순위가 높은 J1이 실행되지 않는 현상 발생
1. 낮은 우선 순위 태스크가 공유 자원에 접근한다.
2. 높은 우선 순위의 태스크가 공유 자원을 접근하려고 하나, 락이 걸린 것을 확인해서 기다린다.
3. 중간 우선 순위 태스크가 낮은 우선 순위의 태스크를 선점한다.
    1. 높은 우선순위 태스크는 선점했다가 공유자원이 rock 되어있으므로 wait 상태에 있음
    2. 이 때 마침 낮은 우선순위 태스크에서 rock을 해제함
    3. 그럴 때 ready 상태에 있던 중간 우선순위 태스크가 낮은 우선순위 task를 선점하면?
    4. 중간 우선순위 task가 높은 우선순위 task보다 먼저 일어나버림
        1. 중간 우선순위가 먼저 일어났는데, 사실 중간 우선순위 task는 반드시 높은 우선순위 이후에 발생해야 한다면? → 문제 발생 !! !!

<aside>

# 💖 우선 순위 계승 프로토콜

</aside>

## 우선 순위 전도 현상의 해결 방법

결국 위의 문제가 일어난 이유는 **중간 우선순위 task가 높은 우선순위 task를 block하게 됐기 때문**

## 우선 순위 계승 프로토콜이란?

**어떤 태스크가 높은 우선 순위를 갖는 태스크를 블록 시켰을 경우** 그 태스크는 그 태스크에 의해서 블록된 태스크 중 가장 높은 우선 순위를 갖는 태스크의 **우선 순위를 상속받는다**.

- 그리고 **임계영역을 벗어날 때 우선순위를 되돌려 놓는다**

## 우선 순위 계승 프로토콜에서 발생할 수 있는 문제점

### push-through blocking

![image.png](image%2052.png)

작은 문제라고 한다.

## 우선 순위 계승 프로토콜로도 해결이 안 되는 문제점

### transitive blocking

![image.png](image%2053.png)

- t6~t7에서, J1은 사실 S1을 기다릴 필요가 없지만 J2때문에 엮여서 J3를 기다려야만 한다.
    - 우선순위 계승 프로토콜때문에 발생하는 건 아니지만, 이걸로도 해결이 안 되는 문제라고 한다.

### Deadlock

![image.png](image%2054.png)